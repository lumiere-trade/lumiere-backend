# Alembic Database Migrations Guide

## Overview

Pourtier uses Alembic for database schema migrations. This guide covers setup, workflow, and best practices.

---

## Architecture

### Database Setup Flow
```
1. docker-compose up
   |
2. Postgres starts -> runs init scripts
   | Creates pourtier_user + pourtier_test_db
   |
3. Pourtier starts (app connects to DB)
   |
4. Manual: alembic upgrade head
   | Creates schema (tables, indexes, constraints)
   |
5. Application ready
```

### Separation of Concerns

| Component | Purpose | When Runs | Owner |
|-----------|---------|-----------|-------|
| **Init Scripts** | Create database & user | First postgres startup | Infrastructure |
| **Alembic Migrations** | Create/modify schema | Manual deployment step | Application |
| **Application** | Use database | Every startup | Application |

---

## Initial Setup

### First Time Deployment
```bash
# 1. Start services
docker-compose up -d

# 2. Wait for postgres health check
sleep 10

# 3. Run migrations
docker exec lumiere-pourtier alembic upgrade head

# 4. Verify
docker exec lumiere-postgres psql -U pourtier_user -d pourtier_test_db -c "\dt"
curl http://localhost:8000/health | jq
```

**Expected Output:**
```
7 tables created:
  - alembic_version
  - users
  - subscriptions
  - payments
  - escrow_transactions
  - legal_documents
  - user_legal_acceptances

Database status: healthy
```

---

## Common Commands

### Check Migration Status
```bash
# Current version
docker exec lumiere-pourtier alembic current

# Migration history
docker exec lumiere-pourtier alembic history

# Show migrations
docker exec lumiere-pourtier alembic heads
```

### Apply Migrations
```bash
# Upgrade to latest
docker exec lumiere-pourtier alembic upgrade head

# Upgrade one version
docker exec lumiere-pourtier alembic upgrade +1

# Preview SQL without executing
docker exec lumiere-pourtier alembic upgrade head --sql
```

### Rollback Migrations
```bash
# Downgrade one version
docker exec lumiere-pourtier alembic downgrade -1

# Downgrade to specific version
docker exec lumiere-pourtier alembic downgrade <revision_id>

# Downgrade to base (empty database)
docker exec lumiere-pourtier alembic downgrade base
```

---

## Creating New Migrations

### Workflow
```bash
# 1. Make changes to models.py
vim src/pourtier/infrastructure/persistence/models.py

# 2. Generate migration (autogenerate detects changes)
docker exec lumiere-pourtier alembic revision --autogenerate -m "add user_preferences table"

# 3. Review generated migration
docker exec lumiere-pourtier cat alembic/versions/<new_file>.py

# 4. Edit if needed (autogenerate isn't perfect)
vim pourtier/alembic/versions/<new_file>.py

# 5. Test migration
docker exec lumiere-pourtier alembic upgrade head

# 6. Verify changes
docker exec lumiere-postgres psql -U pourtier_user -d pourtier_test_db -c "\d user_preferences"

# 7. Commit migration file
git add pourtier/alembic/versions/<new_file>.py
git commit -m "migration: add user_preferences table"
```

### Manual Migration (when autogenerate fails)
```bash
# Create empty migration
docker exec lumiere-pourtier alembic revision -m "custom_change"

# Edit the generated file
vim pourtier/alembic/versions/<new_file>.py
```

Example manual migration:
```python
def upgrade() -> None:
    op.execute("""
        CREATE INDEX CONCURRENTLY idx_users_created_at_desc 
        ON users (created_at DESC)
    """)

def downgrade() -> None:
    op.execute("DROP INDEX idx_users_created_at_desc")
```

---

## Migration Best Practices

### 1. Always Review Autogenerated Migrations

Alembic autogenerate is smart but not perfect:
- Detects: new tables, columns, indexes
- May miss: renames, data migrations, complex constraints

**Always review and test.**

### 2. Naming Conventions
```bash
# Good migration names
alembic revision -m "add email to users"
alembic revision -m "create payments table"
alembic revision -m "add index on wallet_address"

# Bad migration names
alembic revision -m "updates"
alembic revision -m "changes"
alembic revision -m "fix"
```

### 3. Data Migrations

For data changes, use separate migrations:
```python
def upgrade() -> None:
    # 1. Add new column
    op.add_column('users', sa.Column('email_verified', sa.Boolean(), nullable=True))
    
    # 2. Set default values
    op.execute("UPDATE users SET email_verified = false WHERE email_verified IS NULL")
    
    # 3. Make column non-nullable
    op.alter_column('users', 'email_verified', nullable=False)

def downgrade() -> None:
    op.drop_column('users', 'email_verified')
```

### 4. Test Migrations
```bash
# Test upgrade
docker exec lumiere-pourtier alembic upgrade head

# Test downgrade
docker exec lumiere-pourtier alembic downgrade -1

# Test re-upgrade
docker exec lumiere-pourtier alembic upgrade head
```

### 5. Never Edit Applied Migrations

Once a migration is in production:
- Never edit the migration file
- Create a new migration to fix issues

---

## Troubleshooting

### Problem: "alembic_version table not found"
```bash
# Reset alembic state
docker exec lumiere-pourtier alembic stamp base
docker exec lumiere-pourtier alembic upgrade head
```

### Problem: "Table already exists"
```bash
# Check current state
docker exec lumiere-postgres psql -U pourtier_user -d pourtier_test_db -c "\dt"

# Option 1: Mark as migrated without running
docker exec lumiere-pourtier alembic stamp head

# Option 2: Full reset (DESTRUCTIVE)
docker-compose down -v
docker-compose up -d
docker exec lumiere-pourtier alembic upgrade head
```

### Problem: Migration fails mid-execution
```bash
# Alembic uses transactions - failed migrations rollback automatically
# Check current state
docker exec lumiere-pourtier alembic current

# Fix the migration file
vim pourtier/alembic/versions/<migration>.py

# Rebuild image with fixed migration
docker build -f pourtier/Dockerfile --target development -t pourtier:development .

# Try again
docker exec lumiere-pourtier alembic upgrade head
```

### Problem: Autogenerate detects unwanted changes
```bash
# Review what would be generated
docker exec lumiere-pourtier alembic revision --autogenerate -m "test" --sql

# Common causes:
# 1. Models don't match database state
# 2. Import issues in env.py
# 3. SQLAlchemy type mismatches

# Fix models or mark current state as head
docker exec lumiere-pourtier alembic stamp head
```

---

## Database URL Configuration

### Priority Order
```
1. docker-compose.yaml environment
2. pourtier/.env.development
3. pourtier/config/development.yaml
4. Pydantic defaults
```

### Current Setup

**Application (Async):**
```
DATABASE_URL=postgresql+asyncpg://pourtier_user:pourtier_pass@postgres:5432/pourtier_test_db
```

**Alembic (Sync - auto-converted in env.py):**
```
postgresql://pourtier_user:pourtier_pass@postgres:5432/pourtier_test_db
```

**Conversion Logic (alembic/env.py):**
```python
database_url = os.getenv("DATABASE_URL")
if database_url and "postgresql+asyncpg://" in database_url:
    database_url = database_url.replace("postgresql+asyncpg://", "postgresql://")
    config.set_main_option("sqlalchemy.url", database_url)
```

---

## Production Deployment

### Pre-deployment Checklist

- [ ] All migrations tested locally
- [ ] Migration files committed to git
- [ ] Backup database before migration
- [ ] Review migration SQL with `--sql` flag
- [ ] Test rollback procedure

### Deployment Steps
```bash
# 1. Backup database
pg_dump -U pourtier_user -d pourtier_db > backup_$(date +%Y%m%d).sql

# 2. Pull latest code
git pull origin main

# 3. Rebuild image
docker build -f pourtier/Dockerfile --target production -t pourtier:production .

# 4. Stop application (keep database running)
docker-compose stop pourtier

# 5. Run migrations
docker run --rm --network lumiere-network \
  -e DATABASE_URL=postgresql+asyncpg://pourtier_user:PROD_PASS@postgres:5432/pourtier_db \
  pourtier:production \
  alembic upgrade head

# 6. Start application
docker-compose up -d pourtier

# 7. Verify
curl https://api.lumiere.trade/health | jq
```

### Rollback Procedure
```bash
# 1. Stop application
docker-compose stop pourtier

# 2. Rollback migration
docker run --rm --network lumiere-network \
  -e DATABASE_URL=postgresql+asyncpg://pourtier_user:PROD_PASS@postgres:5432/pourtier_db \
  pourtier:production \
  alembic downgrade -1

# 3. Deploy previous application version
docker-compose up -d pourtier
```

---

## Advanced Usage

### Branch Migrations (for parallel development)
```bash
# Create branch point
docker exec lumiere-pourtier alembic revision -m "branch_point"

# Create branch A
docker exec lumiere-pourtier alembic revision -m "feature_a"

# Create branch B (from same parent)
docker exec lumiere-pourtier alembic revision -m "feature_b"

# Merge branches
docker exec lumiere-pourtier alembic merge -m "merge_features" <rev_a> <rev_b>
```

### Offline SQL Generation
```bash
# Generate SQL for all pending migrations
docker exec lumiere-pourtier alembic upgrade head --sql > migration.sql

# Review and apply manually
psql -U pourtier_user -d pourtier_db -f migration.sql
```

### Custom Migration Templates

Edit `alembic/script.py.mako` to customize generated migrations.

---

## Files Overview
```
pourtier/
├── alembic/
│   ├── env.py              # Alembic environment config (async->sync conversion)
│   ├── script.py.mako      # Migration template
│   └── versions/
│       └── 20251017_*.py   # Migration files (timestamped)
├── alembic.ini             # Alembic configuration
└── src/pourtier/infrastructure/persistence/
    └── models.py           # SQLAlchemy models (source of truth)
```

---

## Key Concepts

### Migration = Version Control for Database

Just like Git tracks code changes, Alembic tracks database schema changes.

### Revision Chain
```
base -> 001_initial -> 002_add_email -> 003_add_index -> head
```

### Idempotent Operations

Migrations should be safe to run multiple times:
```python
# Good
op.create_table('users', ..., if_not_exists=True)

# Better (let Alembic handle state)
op.create_table('users', ...)
```

---

## Resources

- Alembic Documentation: https://alembic.sqlalchemy.org/
- SQLAlchemy Documentation: https://docs.sqlalchemy.org/
- Pourtier Models: ../src/pourtier/infrastructure/persistence/models.py

---

## Quick Reference
```bash
# Status
alembic current               # Show current version
alembic history              # Show all migrations
alembic heads                # Show head revisions

# Migrations
alembic upgrade head         # Apply all pending
alembic upgrade +1           # Apply next migration
alembic downgrade -1         # Revert last migration
alembic downgrade base       # Revert all migrations

# Creation
alembic revision --autogenerate -m "message"  # Auto-detect changes
alembic revision -m "message"                 # Empty migration

# Utilities
alembic upgrade head --sql   # Preview SQL
alembic stamp head           # Mark as migrated without running
alembic merge -m "msg" <a> <b>  # Merge branches
```

---

**Remember:** Migrations are code. Test them, review them, and version control them.
